<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prototipo ‚Äî Dashboard Docente </title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
  Chart.register(ChartDataLabels);
</script>


  <style>
    :root{
      --bg:#f4f7fb; --card:#ffffff; --primary:#4a6cf7; --accent:#06b6d4; --muted:#6b7280;
      --good:#16a34a; --warn:#f59e0b; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);margin:0;color:#0f172a}
    header h1 {
  margin: 0;
  font-size: 26px;      /* antes era 20px */
  font-weight: 700;
}
header {
  background: linear-gradient(90deg, var(--primary), #2b4be6) !important;
  color: white;
  padding: 22px 20px;
  box-shadow: 0px 2px 6px rgba(0,0,0,0.05);
}

header h1 {
  margin: 0;
  font-size: 28px;   /* m√°s grande */
  font-weight: 700;
  letter-spacing: -0.5px;
}

header .small {
  color: rgba(255,255,255,0.92) !important; /* se ve MUCHO mejor */
  font-size: 15px;
  margin-top: 4px;
  display: block;
}

    .wrap{max-width:1200px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-bottom:16px}
    .row{display:flex;gap:16px}
    .col{flex:1}
.kpi-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}

.kpi {
  padding: 18px;
  border-radius: 10px;
  background: linear-gradient(180deg,#ffffff,#fbfdff);
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.kpi h3 {
  margin: 0;
  font-size: 14px;
  color: var(--muted);
}

.kpi p {
  margin-top: 6px;
  font-size: 24px;
  font-weight: 700;
}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--primary);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#eef2ff;color:var(--primary)}
    .small{font-size:13px;color:var(--muted)}
    .charts{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    canvas{max-width:100%}
    pre{height:160px;overflow:auto;background:#f8fafc;padding:10px;border-radius:8px}
    .login-card{max-width:480px;margin:36px auto;padding:20px}
    label{display:block;font-size:13px;margin:6px 0}
    input[type="text"], input[type="password"]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8}
    footer{max-width:1200px;margin:10px auto;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:980px){.row{flex-direction:column}.charts{grid-template-columns:1fr}}
    .meta{font-size:13px;color:var(--muted)}

    /* IA Advanced specific */
    .ia-top-cards { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; }
    .ia-card { flex:1; min-width:180px; padding:12px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:0 4px 12px rgba(2,6,23,0.04); }
    .ia-card h4 { margin:0 0 6px; font-size:14px; }
    .ia-card p { margin:0; font-size:13px; color:var(--muted); }
    .ia-narrative { margin-top:12px; padding:12px; background:#fff; border-radius:8px; box-shadow: 0 2px 8px rgba(2,6,23,0.03); }
    .ia-recs-list .ia-rec { margin-bottom:12px; padding:10px; border-radius:8px; background:#fbfdff; }
    .ia-alert { padding:10px; border-left:4px solid var(--danger); background:#fee2e2; color:#7a2b2b; border-radius:6px; }
    .ia-warn { padding:10px; border-left:4px solid var(--warn); background:#fffbeb; color:#664d03; border-radius:6px; }
    .spinner { display:inline-block; width:16px; height:16px; border-radius:50%; border:3px solid rgba(0,0,0,0.08); border-top-color:var(--primary); animation:spin 1s linear infinite; vertical-align:middle; margin-right:8px;}
    @keyframes spin { to { transform:rotate(360deg);} }

    /* layout tweaks for 7 charts */
    .charts .card { padding:10px; }
    .chart-container {
  position: relative;
  width: 100%;
  height: 340px; /* evita recorte */
}
.chart-vertical {
  position: relative;
  width: 100%;
  height: 300px !important; /* ajustable */
}


    .full-width { grid-column: 1 / -1; }
    .ia-rec .small {
    white-space: pre-line;
}

  </style>

</head>
<body>
  <header>
    <div class="wrap">
      <h1>Proyecto Hackathon - Asistente Virtual AI</h1>
      <div class="small">Plataforma virtual para monitorear bienestar del aula y brindar recomendaciones generadas por la IA basadas en el Manual de Tutor√≠a y Orientaci√≥n Educativa. </div>
    </div>
  </header>

  <main class="wrap">
    <!-- LOGIN -->
    <div id="loginWrap" class="card login-card">
      <h3>Ingreso docente</h3>
      <div class="small">Usa las credenciales creadas en la BD (ej. profesor1 / pass1)</div>
      <label>Usuario</label>
      <input id="inpUser" type="text" placeholder="ej: profesor1" />
      <label>Contrase√±a</label>
      <input id="inpPass" type="password" placeholder="ej: pass1" />
      <div style="margin-top:10px;display:flex;gap:8px">
        <button id="btnLogin" class="btn">Entrar</button>
        <button id="btnDemo" class="btn secondary">Demo (aula 1)</button>
      </div>
      <div id="loginMsg" class="meta" style="margin-top:8px"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" style="display:none">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h2 id="teacherTitle" style="margin:0">‚Äî</h2>
            <div class="meta" id="aulaTitle">Aula: ‚Äî</div>
          </div>
          <div class="controls">
            <button id="btnRefresh" class="btn">Actualizar</button>
            <button id="btnExport" class="btn secondary">Exportar respuestas</button>
            <button id="btnAnalyze" class="btn">Ejecutar an√°lisis IA</button>
          </div>
        </div>
      </div>

      <!-- KPIs -->
<div class="row">
  <div class="col card">
    <div class="kpi-row">

      <div class="kpi">
        <h3>üòä Alegr√≠a</h3>
        <p id="kpiAlegria">0%</p>
      </div>

      <div class="kpi">
        <h3>üò£ Estr√©s / Ansiedad</h3>
        <p id="kpiStress">0%</p>
      </div>

      <div class="kpi">
        <h3>üî• Motivaci√≥n Alta</h3>
        <p id="kpiMotAlta">0%</p>
      </div>

      <div class="kpi">
        <h3>üîã Energ√≠a Alta</h3>
        <p id="kpiEnerAlta">0%</p>
      </div>

      <div class="kpi">
        <h3>üòî Tristeza</h3>
        <p id="kpiTristeza">0%</p>
      </div>

      <div class="kpi">
        <h3>‚ö†Ô∏è Ambiente Tenso/Dif√≠cil</h3>
        <p id="kpiAmbTenso">0%</p>
      </div>

    </div>

    <div style="margin-top:12px" class="small">Indicadores actualizados</div>
  </div>

  <div class="col card">
    <h3 style="margin-top:0">Resumen r√°pido</h3>
    <div class="small">Total respuestas: <strong id="totalResponses">0</strong></div>
    <div class="small" style="margin-top:8px">√öltima actualizaci√≥n: <span id="lastUpdated">‚Äî</span></div>
    <div style="margin-top:10px">
      <div id="alertsArea"></div>
    </div>
  </div>
</div>


      <!-- GR√ÅFICOS (7 distintos) -->
      <div class="charts">
        <div class="card">
          <div class="small section-title">1) Emociones</div>
<div class="chart-container">
    <canvas id="chartEmotions"></canvas>
</div>
        </div>

        <div class="card">
          <div class="small section-title">2) Motivaci√≥n</div>
          <canvas id="chartMotivation"></canvas>
        </div>

        <div class="card">
          <div class="small section-title">3) Atenci√≥n</div>
<div class="chart-vertical">
  <canvas id="chartAttention"></canvas>
</div>
        </div>

        <div class="card">
          <div class="small section-title">4) Energ√≠a</div>
          <canvas id="chartEnergy"></canvas>
        </div>

        <div class="card">
          <div class="small section-title">5) Ambiente</div>
          <canvas id="chartAmbiente"></canvas>
        </div>

        <div class="card">
          <div class="small section-title">6) Acompa√±amiento</div>
          <canvas id="chartAcompanamiento"></canvas>
        </div>

        <div class="card">
  <div class="small section-title">7) Tema que quieren trabajar</div>
  <canvas id="chartTema"></canvas>
</div>


      </div>

      <!-- PANEL IA AVANZADO -->
      <div id="panelIA" class="card" style="margin-top:16px">
        <h3 style="margin-top:0">An√°lisis IA ‚Äî Panel avanzado</h3>

        <div id="iaTopBand" style="margin-top:8px"></div>

        <div class="ia-top-cards" id="iaTopCards" style="margin-top:10px"></div>

        <div id="iaNarrative" class="ia-narrative" style="display:none"></div>

        <div class="ia-recs-list" id="iaRecsList" style="margin-top:12px"></div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="btnIArefresh" class="btn">Actualizar recomendaciones IA</button>
          <div id="iaStatus" class="small" style="color:var(--muted)"></div>
        </div>
      </div>

    </div>
  </main>

  <footer>Proyecto AulaSense ‚Äî Prototipo ¬∑ Backend con SQLite</footer>

<script>
/* docente.html final ‚Äî 7 gr√°ficos, IA solo con bot√≥n, mantiene estructura original */

const btnLogin = document.getElementById('btnLogin');
const btnDemo = document.getElementById('btnDemo');
const btnRefresh = document.getElementById('btnRefresh');
const btnExport = document.getElementById('btnExport');
const btnAnalyze = document.getElementById('btnAnalyze');
const btnIArefresh = document.getElementById('btnIArefresh');

const iaTopBand = document.getElementById('iaTopBand');
const iaTopCards = document.getElementById('iaTopCards');
const iaNarrative = document.getElementById('iaNarrative');
const iaRecsList = document.getElementById('iaRecsList');
const iaStatus = document.getElementById('iaStatus');

let currentAulaId = null;
let teacherName = null;
let autoRefresh = null;

btnLogin.addEventListener('click', async () => {
  const u = document.getElementById('inpUser').value.trim();
  const p = document.getElementById('inpPass').value.trim();

  if (!u || !p) {
    document.getElementById('loginMsg').textContent = 'Ingrese usuario y contrase√±a.';
    return;
  }

  document.getElementById('loginMsg').textContent = 'Iniciando...';

  try {
    const resp = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: u, password: p })
    });

    const d = await resp.json();

    if (!resp.ok) {
      document.getElementById('loginMsg').textContent = d.error || 'Credenciales inv√°lidas';
      return;
    }

    teacherName = d.username || d.user || 'Docente';
    currentAulaId = d.aulaId || d.aula_id || null;

    if (!currentAulaId) {
      document.getElementById('loginMsg').textContent = "Aula no asignada.";
      return;
    }

    const aulasResp = await fetch('/api/aulas');
    const aulasList = await aulasResp.json();
    const aula = aulasList.find(a => parseInt(a.id) === parseInt(currentAulaId));
    const aulaNombre = aula ? aula.nombre : `Aula ${currentAulaId}`;

    document.getElementById('teacherTitle').innerHTML = `Docente: <strong>${teacherName}</strong>`;
document.getElementById('aulaTitle').textContent = `Aula ‚Äî ${aulaNombre}`;

    document.getElementById('loginWrap').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('loginMsg').textContent = '';

    await loadAll();

    if (autoRefresh) clearInterval(autoRefresh);
    // auto-refresh LOAD DATA only (no IA)
    autoRefresh = setInterval(() => loadRaw(currentAulaId), 45000);

  } catch (e) {
    console.error(e);
    document.getElementById('loginMsg').textContent = 'Error al conectar con el servidor.';
  }
});

btnDemo.addEventListener('click', async ()=>{
  teacherName = 'Profesor Demo'; currentAulaId = 1;
  document.getElementById('teacherTitle').innerHTML = `Docente: <strong>${teacherName}</strong>`;
  document.getElementById('aulaTitle').textContent = `Aula: Demo (id: ${currentAulaId})`;
  document.getElementById('loginWrap').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  await loadAll();
  if (autoRefresh) clearInterval(autoRefresh);
  autoRefresh = setInterval(()=>loadRaw(currentAulaId), 45000);
});

btnRefresh.addEventListener('click', ()=> loadRaw(currentAulaId));
btnExport.addEventListener('click', exportResponses);
btnAnalyze.addEventListener('click', async ()=> {
   const payload = await loadAnalyze(currentAulaId);
   if(payload) {
       renderAdvancedPanel(payload);
       iaStatus.textContent = 'An√°lisis IA actualizado: ' + new Date().toLocaleTimeString();
   }
});
btnIArefresh.addEventListener('click', async ()=> { await loadIApanel(); });

async function loadAll(){
  if(!currentAulaId){ alert('Aula no asignada'); return; }
  await loadRaw(currentAulaId);   // only load data (no IA)
}

/* Helper to normalize various response shapes and include 'tema' */
function extractFieldsFromResponse(r) {
  const out = { emocion:'', motivacion:'', atencion:'', energia:'', ambiente:'', acompanamiento:'', tema:'', notes:[] };

  // r may be { data: {...} } or already-parsed object
  let d = (r && r.data !== undefined) ? r.data : r;

  if (typeof d === "string") {
    try { d = JSON.parse(d); } catch(e){ d = {}; }
  }
  if (!d || typeof d !== 'object') return out;

  // answers[] preferred
  if (Array.isArray(d.answers)) {
    d.answers.forEach(a=>{
      const q = (a.qid||'').toLowerCase();
      const v = (a.value||'').toString();
      if (q.includes('emoc')) out.emocion = v;
      else if (q.includes('motiv')) out.motivacion = v;
      else if (q.includes('ener')) out.energia = v;
      else if (q.includes('aten')||q.includes('part')||q.includes('clase')) out.atencion = v;
      else if (q.includes('ambi')) out.ambiente = v;
      else if (q.includes('acom')||q.includes('amig')) out.acompanamiento = v;
      else if (q.includes('tema')) out.tema = v;
      else if (typeof v === 'string' && v.trim().length>2) out.notes.push(v);
    });
    return out;
  }

  // flat keys fallback
  const mapKey = key => {
    const k = key.toLowerCase();
    if (k.includes('emoc')) return 'emocion';
    if (k.includes('motiv')) return 'motivacion';
    if (k.includes('ener')) return 'energia';
    if (k.includes('atenc')||k.includes('part')||k.includes('clase')) return 'atencion';
    if (k.includes('ambi')) return 'ambiente';
    if (k.includes('acomp')||k.includes('amig')) return 'acompanamiento';
    if (k.includes('tema')) return 'tema';
    return null;
  };

  Object.entries(d).forEach(([k,v])=>{
    const mk = mapKey(k);
    if (mk) out[mk] = (v||'').toString();
    else if (typeof v === 'string' && v.trim().length>2) out.notes.push(v);
  });

  return out;
}

/* LOAD RAW: obtiene respuestas y actualiza todos los gr√°ficos */
async function loadRaw(aulaId){
  if(!aulaId){ console.warn('loadRaw: falta aulaId'); return; }
  try {
    const res = await fetch(`/api/respuestas/${aulaId}`);
    if(!res.ok){
      document.getElementById('totalResponses').textContent = '0';
      document.getElementById('lastUpdated').textContent = '‚Äî';
      document.getElementById('alertsArea').innerHTML = '<div class="small">No se pueden obtener respuestas.</div>';
      return;
    }
    const arr = await res.json();

    // totals
    const totals = { emocion:{}, motivacion:{}, atencion:{}, energia:{}, ambiente:{}, acompanamiento:{}, tema:{}, notes:[] };

    arr.forEach(r=>{
      const e = extractFieldsFromResponse(r);
      if(e.emocion) totals.emocion[e.emocion] = (totals.emocion[e.emocion]||0)+1;
      if(e.motivacion) totals.motivacion[e.motivacion] = (totals.motivacion[e.motivacion]||0)+1;
      if(e.atencion) totals.atencion[e.atencion] = (totals.atencion[e.atencion]||0)+1;
      if(e.energia) totals.energia[e.energia] = (totals.energia[e.energia]||0)+1;
      if(e.ambiente) totals.ambiente[e.ambiente] = (totals.ambiente[e.ambiente]||0)+1;
      if(e.acompanamiento) totals.acompanamiento[e.acompanamiento] = (totals.acompanamiento[e.acompanamiento]||0)+1;
      if(e.tema) totals.tema[e.tema] = (totals.tema[e.tema]||0)+1;
      if(e.notes && e.notes.length) totals.notes.push(...e.notes);
    });

    document.getElementById('totalResponses').textContent = arr.length;
    document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

    // KPIs
    const total = arr.length || 1;
    const pct = n => Math.round((n/total)*100);

    const alegria = totals.emocion['üòÑ Alegr√≠a'] || totals.emocion['Alegr√≠a'] || totals.emocion['Alegria'] || 0;
    const stress = (totals.emocion['üò£ Estr√©s']||0) + (totals.emocion['üòü Ansiedad']||0) + (totals.emocion['Estr√©s']||0) + (totals.emocion['Ansiedad']||0);
    const motAlta = totals.motivacion['Alta üî•'] || totals.motivacion['Alta'] || 0;
    const enerAlta = totals.energia['Alta üîã'] || totals.energia['Alta'] || 0;
    const tristeza = totals.emocion['üòî Tristeza'] || totals.emocion['Tristeza'] || 0;
const ambienteTenso = 
    (totals.ambiente['Tenso'] || 0) +
    (totals.ambiente['Dif√≠cil'] || totals.ambiente['Dificil'] || 0);


    document.getElementById('kpiAlegria').textContent = pct(alegria) + '%';
    document.getElementById('kpiStress').textContent = pct(stress) + '%';
    document.getElementById('kpiMotAlta').textContent = pct(motAlta) + '%';
    document.getElementById('kpiEnerAlta').textContent = pct(enerAlta) + '%';
    document.getElementById('kpiTristeza').textContent = pct(tristeza) + '%';
document.getElementById('kpiAmbTenso').textContent = pct(ambienteTenso) + '%';


    // Prepare each chart dataset and render individually
    // 1) Emociones (order fixed)
    const emotionLabels = ['üòÑ Alegr√≠a','üôÇ Tranquilidad','üòê Neutral','üò£ Estr√©s','üòî Tristeza','üòï Confusi√≥n','üò° Molestia','üò¥ Cansancio','üòü Ansiedad'];
    const emotionData = emotionLabels.map(l => totals.emocion[l] || totals.emocion[l.replace(/^[^ ]+ /,'')] || 0);
renderHorizontalBar('chartEmotions', emotionLabels, emotionData);

    // 2) Motivaci√≥n
    const motLabels = ['Alta üî•','Media üôÇ','Baja üò¥'];
    const motData = motLabels.map(l => totals.motivacion[l] || totals.motivacion[l.split(' ')[0]] || 0);
renderDoughnut('chartMotivation', motLabels, motData);

    // 3) Atenci√≥n
    const atLabels = ['S√∫per atento','Atento a medias','Perdido','Cansado'];
    const atData = atLabels.map(l => totals.atencion[l] || 0);
renderBar('chartAttention', atLabels, atData);

    // 4) Energ√≠a
    const enerLabels = ['Alta üîã','Media üîã','Baja ü™´'];
    const enerData = enerLabels.map(l => totals.energia[l] || totals.energia[l.split(' ')[0]] || 0);
renderLine('chartEnergy', enerLabels, enerData);

    // 5) Ambiente (pie)
    const ambLabels = ['Muy bueno','Bueno','Normal','Tenso','Dif√≠cil'];
    const ambData = ambLabels.map(l => totals.ambiente[l] || 0);
renderPie('chartAmbiente', ambLabels, ambData);

    // 6) Acompa√±amiento
    const compLabels = ['S√≠','M√°s o menos','No'];
    const compData = compLabels.map(l => totals.acompanamiento[l] || totals.acompanamiento[l.replace('√≠','i')] || 0);
renderRadar('chartAcompanamiento', compLabels, compData);

    // 7) Tema (pie / bar)
    const temaLabels = Object.keys(totals.tema || {});
    const temaData = temaLabels.map(k => totals.tema[k] || 0);
    if(temaLabels.length) {
      renderPie('chartTema', temaLabels, temaData);
    } else {
      renderPie('chartTema', ['Sin datos'], [1]);
    }

    // Build alerts & simple recommendations (heuristics)
    const alerts = [];
    const recs = [];
    if(pct(stress) >= 25) {
      alerts.push('Alto nivel de estr√©s/ansiedad en el aula (‚â•25%).');
      recs.push({ title: 'Tutor√≠a emocional ‚Äî sesi√≥n de contenci√≥n', desc: '20-30 min: respiraci√≥n, escucha activa, grupos peque√±os. Derivar si hay riesgo.' , source:'Unidad 3' });
    } else if(pct(stress) >= 10) {
      alerts.push('Incremento de se√±ales de estr√©s (‚â•10%).');
      recs.push({ title: 'Ejercicio de regulaci√≥n (5-10 min)', desc: 'Respiraci√≥n guiada y mini-rutina de atenci√≥n.' , source:'Unidad 2' });
    }
    if(pct(motAlta) <= 30) {
      recs.push({ title: 'Actividad motivacional breve', desc: 'Din√°mica de metas a corto plazo y reconocimiento en clase.' , source:'Unidad 1' });
    }
    const lostPct = Math.round(((totals.atencion['Perdido']||0)/total)*100);
    if(lostPct >= 20) {
      alerts.push('Alta proporci√≥n de estudiantes "Perdido" en clase (‚â•20%).');
      recs.push({ title: 'Din√°mica de atenci√≥n y participaci√≥n', desc: 'Roles rotativos y actividades cortas con feedback.' , source:'Unidad 4' });
    }

    const alertsArea = document.getElementById('alertsArea');
    alertsArea.innerHTML = alerts.length ? alerts.map(a=>`<div style="padding:8px;border-left:4px solid ${a.toLowerCase().includes('alto')? 'var(--danger)':'var(--warn)'};margin-bottom:6px">${a}</div>`).join('') : '<div class="small">Sin alertas cr√≠ticas</div>';

    // Store last totals on window for IA panel use
    window.__aulaTotals = totals;
    window.__aulaRawCount = arr.length;

  } catch (err) {
    console.error('loadRaw error', err);
    const alertsArea = document.getElementById('alertsArea');
    alertsArea.innerHTML = `<div class="ia-warn">Error al obtener datos del servidor.</div>`;
  }
}

/* CHART HELPERS */
let chartInstances = {};
function renderBar(id, labels, data){
const canvas = document.getElementById(id);
  canvas.parentNode.style.height = "300px";
  if(chartInstances[id]) chartInstances[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');

  chartInstances[id] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: labels.map((_,i)=> `hsl(${(i*40)%360} 80% 55%)`)
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,

      plugins: {
        legend: { display: false },

        datalabels: {
       anchor: 'center',
  align: 'center',
  color: '#fff',
  font: { weight: 'bold', size: 12 },

          formatter: (value, ctx) => {
            const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
            if (!total || value === 0) return "";
            return Math.round((value/total)*100) + "%";
          }
        }
      },

      scales: {
        y: { beginAtZero: true, ticks: { precision: 0 } }
      }
    }
  });
}

function renderPie(id, labels, data){
  if(chartInstances[id]) chartInstances[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  chartInstances[id] = new Chart(ctx, {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: labels.map((_,i)=> `hsl(${(i*60)%360} 70% 50%)`)
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' },
        datalabels: {
          color: '#fff',
          font: { weight: 'bold', size: 14 },
          formatter: (value, ctx) => {
            const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0) || 1;
            return Math.round((value/total)*100) + "%";
          }
        }
      }
    }
  });
}


function renderHorizontalBar(id, labels, data){
  if(chartInstances[id]) chartInstances[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');

  chartInstances[id] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: labels.map((_,i)=> `hsl(${(i*35)%360} 70% 50%)`)
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,

      plugins: {
        legend: { display: false },

        datalabels: {
          anchor: 'center',     /* ‚Üê dentro de la barra */
          align: 'center',      /* ‚Üê centrado total */
          color: '#fff',
          font: { weight: 'bold', size: 12 },

          formatter: (value, ctx) => {
            const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
            if (!total || value === 0) return "";
            return Math.round((value/total)*100) + "%";
          }
        }
      },

      scales: {
        x: { beginAtZero: true }
      }
    }
  });
}


function renderDoughnut(id, labels, data){
    if(chartInstances[id]) chartInstances[id].destroy();
    const ctx = document.getElementById(id).getContext('2d');
    chartInstances[id] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels,
            datasets: [{
                data,
                backgroundColor: labels.map((_, i) => `hsl(${(i*45)%360} 70% 55%)`)
            }]
        },
        options:{
    responsive:true,
   plugins: {
    legend: { position: 'bottom' },
    datalabels: {
   color: '#fff',
  font: { weight: 'bold', size: 14 },
  textAlign: 'center',
        formatter: (value, ctx) => {
            const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
            if (!total) return "";
            return Math.round((value/total)*100) + "%";
        }
    }
}

}

    });
}

function renderLine(id, labels, data){
    if(chartInstances[id]) chartInstances[id].destroy();
    const ctx = document.getElementById(id).getContext('2d');
    chartInstances[id] = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [{
                data,
                borderWidth: 2,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false },
            datalabels:{
    anchor:'end',
    align:'top',
    formatter:(value)=> value
}

        },
            scales: { y: { beginAtZero: true } }
        }
    });
}
function renderRadar(id, labels, data) {
    if (chartInstances[id]) chartInstances[id].destroy();
    const ctx = document.getElementById(id).getContext("2d");
    
    chartInstances[id] = new Chart(ctx, {
        type: "radar",
        data: {
            labels,
            datasets: [{
                data,
                fill: true,
                borderWidth: 2,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
                pointBackgroundColor: "rgba(54, 162, 235, 1)"
            }]
        },
        options: {
            responsive: true,
            plugins:{
    legend:{ display:false },
    datalabels:{
        color:'#000',
        formatter:value => value
    }
}

        }
    });
}

/* Export responses */
async function exportResponses(){
  if(!currentAulaId) return alert('Aula no asignada.');
  const res = await fetch(`/api/respuestas/${currentAulaId}`);
  if(!res.ok) return alert('No se pudo obtener respuestas.');
  const arr = await res.json();
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `responses_aula_${currentAulaId}.json`; a.click();
}

/* IA: Llamada para obtener recomendaciones (no se auto lanza) */
async function loadAnalyze(aulaId){
  if(!aulaId) return alert('Aula no asignada.');
  try{
    const res = await fetch('/api/ia/recomendaciones', {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ aulaId })
    });
    if(!res.ok) {
      console.warn('IA endpoint no disponible');
      return null;
    }
    const payload = await res.json();
    // render brief stats in KPIs if provided
    if(payload.stats) renderAnalyzeFromPayload({ stats: payload.stats, totalResponses: payload.stats.total || 0 });
    return payload;
  } catch(e){
    console.error('loadAnalyze error', e);
    return null;
  }
}

/* Ejecuta IA (button) -> obtiene recs y las muestra formateadas */
async function runAnalyze(){
  if(!currentAulaId) return alert('Aula no asignada.');
  const payload = await loadAnalyze(currentAulaId);
  if(!payload) return alert('No se pudo ejecutar IA.');
  // Show IA recs in panelIA area (use renderAdvancedPanel)
  renderAdvancedPanel(payload);
  alert('An√°lisis IA actualizado.');
}

/* PANEL IA avanzado (bot√≥n espec√≠fico) */
async function loadIApanel(){
  if(!currentAulaId) return;
  iaStatus.innerHTML = '<span class="spinner"></span>Analizando...';
  iaTopBand.innerHTML = '';
  iaTopCards.innerHTML = '';
  iaNarrative.style.display = 'none';
  iaNarrative.innerHTML = '';
  iaRecsList.innerHTML = '';

  try{
    const payload = await loadAnalyze(currentAulaId);
    if(!payload) {
      iaStatus.textContent = 'Error: no se obtuvo respuesta de IA';
      iaTopBand.innerHTML = `<div class="ia-warn">No se pudo obtener an√°lisis IA.</div>`;
      return;
    }
    iaStatus.textContent = '√öltimo an√°lisis IA: ' + new Date().toLocaleTimeString();
    iaStatus.style.color = 'var(--muted)';
    renderAdvancedPanel(payload);
  }catch(e){
    console.error('loadIApanel error', e);
    iaStatus.textContent = 'Error en IA';
    iaTopBand.innerHTML = `<div class="ia-warn">Error al consultar IA.</div>`;
    iaStatus.style.color = 'var(--danger)';
  }
}

function cleanJsonLikeText(str) {
  if (typeof str !== "string") return str;
  // Si parece JSON, elimino llaves y comillas
  if (str.trim().startsWith("{") || str.trim().startsWith("[")) {
    return str
      .replace(/[{}"]/g, '')
      .replace(/recs:/gi, '')
      .replace(/summary:/gi, '')
      .replace(/title:/gi, '')
      .replace(/\[\s*\]/g, '')
      .trim();
  }
  return str;
}


/* Formatea y pinta el panel avanzado con el payload de backend */
function renderAdvancedPanel(payload){
  const stats = payload.stats || window.__aulaTotals || {};
  const recs = payload.recs || [];
  const total = stats.total || window.__aulaRawCount || 1;
  const pct = n => Math.round((n/Math.max(1,total))*100);

  const stressCount = (stats.emocion && ((stats.emocion['üò£ Estr√©s']||0) + (stats.emocion['üòü Ansiedad']||0))) || 0;
  const tristezaCount = (stats.emocion && (stats.emocion['üòî Tristeza']||0)) || 0;
  const bajaMot = (stats.motivacion && (stats.motivacion['Baja üò¥']||stats.motivacion['Baja']||0)) || 0;
  const tensoCount = (stats.ambiente && ((stats.ambiente['Tenso']||0) + (stats.ambiente['Dif√≠cil']||0))) || 0;

  let topHtml = '';
  if(pct(stressCount) >= 30 || pct(tensoCount) >= 25){
    topHtml = `<div class="ia-alert"><strong>Atenci√≥n:</strong> Se detectan riesgos (estr√©s / clima tenso) en el aula. Revise las recomendaciones y considere acciones de contenci√≥n.</div>`;
  } else if(pct(tristezaCount) >= 20 || pct(bajaMot) >= 30){
    topHtml = `<div class="ia-warn"><strong>Observaci√≥n:</strong> Se√±ales de des√°nimo o motivaci√≥n baja. Puede requerir actividades motivacionales.</div>`;
  } else {
    topHtml = `<div style="padding:10px;border-left:4px solid var(--good);background:#f0fff4">Estado estable: no hay riesgos cr√≠ticos detectados.</div>`;
  }
  iaTopBand.innerHTML = topHtml;

  iaTopCards.innerHTML = '';
  const cardData = [
    { title: 'Participaci√≥n total', value: stats.total || window.__aulaRawCount || 0, sub: 'Respuestas registradas' },
    { title: 'Estr√©s/Ansiedad', value: pct(stressCount)+'%', sub: 'Proporci√≥n del aula' },
    { title: 'Tristeza', value: pct(tristezaCount)+'%', sub: 'Proporci√≥n del aula' },
    { title: 'Motivaci√≥n baja', value: pct(bajaMot)+'%', sub: 'Proporci√≥n del aula' }
  ];
  cardData.forEach(c => {
    const el = document.createElement('div');
    el.className = 'ia-card';
    el.innerHTML = `<h4>${c.title}</h4><p style="font-weight:700;font-size:18px;margin-top:6px">${c.value}</p><p class="small" style="margin-top:6px">${c.sub}</p>`;
    iaTopCards.appendChild(el);
  });

  // Narrative (friendly)
  let narrative = '';
  if(Array.isArray(recs) && recs.length && recs[0].narrative){
    narrative = recs[0].narrative;
  } else if(payload.narrative){
    narrative = payload.narrative;
  } else {
    narrative = `La IA detect√≥ ${stats.total || 0} respuesta(s). Principales se√±ales: Estr√©s/ansiedad ${pct(stressCount)}%, tristeza ${pct(tristezaCount)}%, motivaci√≥n baja ${pct(bajaMot)}%.`;
    if(pct(stressCount) >= 30 || pct(tensoCount) >= 25){
      narrative += ` Recomendamos priorizar acciones de contenci√≥n emocional y comunicaci√≥n con las familias.`;
    } else if(pct(bajaMot) >= 30){
      narrative += ` Sugerimos actividades motivacionales y proyectos cortos para aumentar enganche.`;
    } else {
      narrative += ` La din√°mica del aula se considera relativamente estable. Mantener seguimiento.`;
    }
  }
  iaNarrative.style.display = 'block';
  iaNarrative.innerHTML = `<strong>An√°lisis sint√©tico:</strong><div style="margin-top:8px" class="small">${narrative}</div>`;

  iaRecsList.innerHTML = '';
  if(!recs || recs.length === 0){
    iaRecsList.innerHTML = `<div class="small">No se encontraron recomendaciones autom√°ticas por IA.</div>`;
  } else {
    recs.forEach(r => {
      const recDiv = document.createElement('div');
      recDiv.className = 'ia-rec card';
      recDiv.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div style="flex:1">
            <strong style="font-size:15px">${r.title || 'Recomendaci√≥n'}</strong>
                <div class="small" style="margin-top:6px">${cleanJsonLikeText(r.text || r.summary || r.desc || '')}</div>
                ${r.steps && r.steps.length ? `<div style="margin-top:8px"><strong>Pasos:</strong><ol class="small">${r.steps.map(s=>`<li>${s}</li>`).join('')}</ol></div>` : ''}
            ${r.materials && r.materials.length ? `<div class="small" style="margin-top:8px"><strong>Materiales:</strong> ${r.materials.join(', ')}</div>` : ''}
            <div class="meta" style="margin-top:8px">Unidad: ${r.ref_unit || r.source || 'Manual'}</div>
          </div>
          <div style="min-width:110px;text-align:right">
            <div class="small">Duraci√≥n aprox.</div>
            <div style="font-weight:700;font-size:18px">${r.duration_min || 15} min</div>
          </div>
        </div>
      `;
      iaRecsList.appendChild(recDiv);
    });
  }
}

/* renderAnalyzeFromPayload -> actualiza KPIs si la IA devuelve stats */
function renderAnalyzeFromPayload(payload){
  const stats = payload.stats || {};
  const total = payload.totalResponses || stats.total || 0;
  const pct = (n) => Math.round((n/Math.max(1,total))*100);
  document.getElementById('kpiAlegria').textContent = pct( (stats.emocion && (stats.emocion['üòÑ Alegr√≠a']||stats.emocion['Alegr√≠a']||stats.emocion['Alegria'])) || 0 ) + '%';
  document.getElementById('kpiStress').textContent = pct( (stats.emocion && ((stats.emocion['üò£ Estr√©s']||0) + (stats.emocion['üòü Ansiedad']||0) + (stats.emocion['Estr√©s']||0) + (stats.emocion['Ansiedad']||0))) || 0 ) + '%';
  document.getElementById('kpiMotAlta').textContent = pct( (stats.motivacion && (stats.motivacion['Alta üî•']||stats.motivacion['Alta']||0)) || 0) + '%';
  document.getElementById('kpiEnerAlta').textContent = pct( (stats.energia && (stats.energia['Alta üîã']||stats.energia['Alta']||0)) || 0) + '%';
  const emotionLabels = Object.keys(stats.emocion||{});
  const emotionData = emotionLabels.map(k => stats.emocion[k] || 0);
  if(emotionLabels.length) renderBar('chartEmotions', emotionLabels, emotionData);
}

/* Ping backend aulas on load (non-blocking) */
(async function initCheck(){
  try{
    await fetch('/api/aulas');
  }catch(e){ console.log('Backend no disponible en /api/aulas'); }
})();
</script>
</body>
</html>


